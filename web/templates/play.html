{% extends "base.html" %}
{% block content %}
    <video height="400" controls="controls">
         <source src="{{url_for('get_video', vid=vid)}}" type='video/mp4; codecs="avc1.42E01E, mp4a.40.2"'>
    </video>
<p class="videoTitle">{{ video.title }}</p>
<p class="videoDate">Добавлено {{video.date}}</p>
{%if user %}
<form action="" method="post">
        <div>{{ form.message.label }}</div>
        <div>{{ form.message(rows=5, cols=60) }}</div>
        {% if form.message.errors %}
            {% for error in form.message.errors %}
            <div style="color: red;">{{ error }}</div>
            {% endfor %}
        {% endif %}
        {{ form.submit }}
</form>

{% else %}
<a href="{{url_for('log')}}" class="Link"><b>Войдите</b></a>, чтобы комментировать
{%endif%}
<p>Просмотры: {{ video.viewers | length }}</p>
<p>Комментарии</p>
<div id="CSect">
{% for comment in video.comments %}
<div class="Comment">
    <img src="../static/a.png" alt="" class="commAva">
    <div class="commTxt">
        <p>{{ comment.user.login }}</p>
        <p>{{ comment.text }}</p>
    </div>
</div>
{% endfor %}
</div>
<script>
        let speed=5000;
        let hash=window.location.href;
        let sl=0;
        for(let i=0;i<hash.length;i++)
            if(hash[i]=='/')sl=i;
        hash=hash.substring(sl+1);
        
        let commSection=document.getElementById("CSect");
        let curComms = document.getElementsByClassName("Comment").length;
        setTimeout(function step(){
            $.ajax({
                       url:"/askNewComm/"+hash,
                       type:"GET",
                       dataType:"text",
                       success:function(response)
                       {
                            if(response>curComms)
                            {
                                   let def=response-curComms;
                                   $.ajax({
                                   url:"/getNewComm/"+hash+"/"+curComms,
                                   type:"GET",
                                   dataType:"text",
                                   success:function(response1)
                                   {
                                     let cur=0;
                                     let cur1=0;
                                     for(let i=0;i<def;i++)
                                     {
                                        while(response1[cur1]!="," || response1[cur1+1]!=",")
                                            cur1++;
                                        let name=response1.substr(cur,cur1-cur);
                                        cur=cur1+2;
                                        while(response1[cur1]!=";" || response1[cur1+1]!=";")
                                            cur1++;
                                        let text=response1.substr(cur,cur1-cur);
                                        commSection.innerHTML+='<div class="Comment"><img src="../static/a.png" alt="" class="commAva"><div class="commTxt"><p>'+name+'</p><p>'+text+'</p></div></div>';
                                     }
                                   },
                                   error:function(){}
                                });
                                curComms=response;
                            }
                       },
                       error:function(){}
                    });
            setTimeout(step,speed);
        },speed);
</script>
{% endblock %}
