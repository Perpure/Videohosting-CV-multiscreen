{% extends "base.html" %}
{% block content %}
<h1>Комната {{room.token}}</h1>
{% if room.capitan_id == user.id %}
{% if room.color_user %}
<form action="" method="post">
    {{Room_Form.hidden_tag()}}
    <a href="{{calibrate_url}}">{{ Room_Form.submit }}</a>
</form>
{% endif %}
<h5>Загрузите калибровочное фото</h5>
<form action="" method="post" enctype="multipart/form-data">
    <div class="Loader"><div><input id="image" name="image" type="file" accept="image/*" capture></div></div>
    <div id="Calibr"> {{ image_form.submit }} </div>
<button class="result" id="showRes">Начать демонстрацию</button>
    {% if map_ex %}
    
    {% endif %}
</form>
{% if room.color_user %}
{% else %}
<p>Пригласите участников в комнату</p>
{% endif %}
{% endif %}
{% if room.capitan_id != user.id %}
<hr>
<button onclick="launchIntoFullscreen(document.documentElement);" class="fullscreenB">Перейти в полноэкранный режим</button>
{% endif %}
<hr>
<h5>Участники</h5>
{% for i in users %}
<p>{{i.login}}</p>
{% endfor %}
{% if map_ex %}
<hr>
<img src="{{url_for('get_multi', pid=room_map)}}" style="width:100%">
{% endif %}
{% if msg %}
    <hr>
    <p>{{msg}}</p>
{% endif %}
<hr>
<p>После того, как вы пригласили участников, разместите их устройства на площади для показа, открыв страницу комнаты. На странице капитана (создавший комнату пользователь) нажмите на кнопку калибровки, после чего на всех устройствах откроется цветная сплошная заливка. Нажмите на кнопку загрузки файла и сделайте фотографию устройств, желательно под прямым углом. Если что-то пошло не так, вы можете убрать лишнее освещение, сделать экран на телефонах ярче. После этого выберите желаемое для показа видео и нажмите на кнопку результата. Все устройства начнут воспроизведение.</p>
{% if room.capitan_id != user.id %}
    <script>
        let speed=3000;
        var prev = "None";
        setTimeout(function step(){
            $.ajax({
                       url:"/askAct",
                       type:"GET",
                       dataType:"text",
                       success:function(response)
                       {
                            if(response=="calibrate" && prev != "calibrate"){
                            prev = "calibrate";
                            $('#Body').prepend('<div id="calibrImage" style="position:fixed; width:110%; height:110%; background:{{color}};"></div>');
                            $('#Footer').prop({"hidden":true})
                            $('#Header').prop({"hidden":true})
                            prev = "calibrate"
                            ;}
                            if(response=="result" && prev != "result"){
                            $('#Body').prepend('<img src="{{url_for('get_multi', pid=1)}}" style="position:fixed; width:{{user.res_k}}%; top:{{user.top}}%; left:{{user.left}}%;">');
                            $('#Footer').prop({"hidden":true})
                            $('#Header').prop({"hidden":true})
                            $('#calibrImage').prop({"hidden":true})
                            prev = "result"
                            }

                       },
                       error:function(){}
                    });
            setTimeout(step,speed);
        },speed);


        $(function() {
            $(document).ready(function() {
            var ratio = window.devicePixelRatio || 1;
            var width = screen.width * ratio;
            var height = screen.height * ratio;
                $.ajax({
                  url: '/tellRes',
                  contentType: "application/json; charset=utf-8",
                  type: "POST",
                  data: JSON.stringify({ "width": width, "height" : height }),
                  success: function () {
                    console.log(JSON.stringify({ "width": width, "height" : height }));},
                  });
                  dataType:"json"
            });
        });

        function launchIntoFullscreen(element) {
              if(element.requestFullscreen) {
                element.requestFullscreen();
              } else if(element.mozRequestFullScreen) {
                element.mozRequestFullScreen();
              } else if(element.webkitRequestFullscreen) {
                element.webkitRequestFullscreen();
              } else if(element.msRequestFullscreen) {
                element.msRequestFullscreen();
              }
            }
</script>
    
{%else%}
<script>
let show=document.getElementById("showRes");
show.addEventListener('click',function(){
    let hash=window.location.href;
    let sl=0;
        for(let i=0;i<hash.length;i++)
            if(hash[i]=='/')sl=i;
    hash=hash.substring(sl+1);
    $.ajax({
                       url:"/showRes/"+hash,
                       type:"GET",
                       dataType:"text",
                       success:function(response){},
                       error:function(){}
                    });
});
</script>
{% endif %}
{% endblock %}

